<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div class="header-title">
        <ion-icon name="stats-chart"></ion-icon>
        <span>Estatísticas</span>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="stats-container" *ngIf="stats">
    
    <!-- Abas de navegação -->
    <ion-card class="tabs-card glass-card">
      <ion-card-content>
        <ion-segment [(ngModel)]="activeTab" mode="md">
        <ion-segment-button value="quiz">
            <div class="segment-content">
              <ion-icon name="school"></ion-icon>
          <ion-label>Quiz</ion-label>
            </div>
        </ion-segment-button>
        <ion-segment-button value="hangman">
            <div class="segment-content">
              <ion-icon name="game-controller"></ion-icon>
              <ion-label>Forca</ion-label>
            </div>
        </ion-segment-button>
      </ion-segment>
      </ion-card-content>
    </ion-card>
    
    <!-- Conteúdo do Quiz -->
    <div *ngIf="activeTab === 'quiz'" class="tab-content">
    
      <!-- Header com nome -->
      <div class="user-header">
        <div class="avatar-wrapper">
          <ion-icon name="person"></ion-icon>
        </div>
        <div class="user-details">
          <h1>{{ stats.userName }}</h1>
          <p class="subtitle">{{ stats.totalAttempts }} {{ stats.totalAttempts === 1 ? 'quiz realizado' : 'quizzes realizados' }}</p>
        </div>
      </div>
      
      <!-- Indicador de evolução -->
      <ion-card class="trend-card glass-card" *ngIf="stats.totalAttempts > 0">
        <ion-card-content>
          <div class="trend-content">
            <ion-icon [name]="getTrendIcon()" [color]="getTrendColor()" class="trend-icon"></ion-icon>
            <div class="trend-text">
              <h3>Evolução</h3>
              <p>{{ getEvolutionMessage() }}</p>
      </div>
    </div>
        </ion-card-content>
      </ion-card>

    <!-- Cards de estatísticas gerais -->
      <div class="stats-grid">
        <ion-card class="stat-card glass-card">
        <ion-card-content>
          <ion-icon name="trophy" color="warning"></ion-icon>
          <div class="stat-value">{{ stats.bestScore }}%</div>
            <div class="stat-label">Melhor</div>
        </ion-card-content>
      </ion-card>

        <ion-card class="stat-card glass-card">
        <ion-card-content>
            <ion-icon name="trending-up" color="primary"></ion-icon>
          <div class="stat-value">{{ stats.averageScore }}%</div>
            <div class="stat-label">Média</div>
        </ion-card-content>
      </ion-card>

        <ion-card class="stat-card glass-card">
        <ion-card-content>
          <ion-icon name="checkbox" color="success"></ion-icon>
          <div class="stat-value">{{ stats.totalAttempts }}</div>
            <div class="stat-label">Total</div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Desempenho por categoria -->
      <ion-card class="category-card glass-card" *ngIf="hasCategoryStats()">
      <ion-card-header>
        <ion-card-title>
            <ion-icon name="analytics"></ion-icon>
            <span>Desempenho por Categoria</span>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
          <div class="category-list">
        <div class="category-item" *ngFor="let category of categoryStatsArray">
          <div class="category-header">
                <div class="category-info">
                  <ion-icon [name]="getCategoryIcon(category.key)" [color]="getCategoryColor(category.value.percentage)"></ion-icon>
                  <span class="category-name">{{ category.key }}</span>
            </div>
                <span class="category-percentage" [style.color]="'var(--ion-color-' + getCategoryColor(category.value.percentage) + ')'">
              {{ category.value.percentage }}%
                </span>
            </div>
              <div class="progress-wrapper">
                <ion-progress-bar 
                  [value]="category.value.percentage / 100" 
                  [color]="getCategoryColor(category.value.percentage)"
                ></ion-progress-bar>
                <span class="progress-detail">{{ category.value.correct }} de {{ category.value.total }}</span>
            </div>
            </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Histórico de tentativas -->
      <ion-card class="history-card glass-card" *ngIf="stats.attempts.length > 0">
      <ion-card-header>
        <div class="history-header">
          <ion-card-title>
              <ion-icon name="time"></ion-icon>
              <span>Histórico</span>
          </ion-card-title>
          <ion-button 
            *ngIf="stats.attempts.length > 5"
            fill="clear" 
            size="small"
            (click)="toggleAllAttempts()"
          >
              {{ showAllAttempts ? 'Ver menos' : 'Ver tudo' }}
          </ion-button>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="attempts-list">
          <div class="attempt-item" *ngFor="let attempt of recentAttempts; let i = index">
              <div class="attempt-badge">
              <ion-icon [name]="getPerformanceIcon(attempt.percentage)" [color]="getPerformanceColor(attempt.percentage)"></ion-icon>
            </div>
              <div class="attempt-info">
                <div class="attempt-score-row">
                  <span class="attempt-score" [style.color]="'var(--ion-color-' + getPerformanceColor(attempt.percentage) + ')'">
                  {{ attempt.percentage }}%
                </span>
                  <span class="attempt-detail">{{ attempt.score }}/{{ attempt.totalQuestions }}</span>
                </div>
                <span class="attempt-date">{{ formatDate(attempt.date) }}</span>
              </div>
              <ion-progress-bar 
                [value]="attempt.percentage / 100" 
                [color]="getPerformanceColor(attempt.percentage)"
                class="attempt-progress"
              ></ion-progress-bar>
            </div>
        </div>
      </ion-card-content>
    </ion-card>

      <!-- Estado vazio -->
      <div class="empty-state" *ngIf="stats.attempts.length === 0">
        <ion-icon name="school-outline" class="empty-icon"></ion-icon>
        <h2>Nenhum quiz realizado</h2>
        <p>Comece agora e acompanhe sua evolução!</p>
        <ion-button (click)="goToQuiz()" color="primary" size="large">
          <ion-icon name="play" slot="start"></ion-icon>
          Fazer Quiz
        </ion-button>
      </div>

    <!-- Ações -->
      <div class="action-buttons" *ngIf="stats.attempts.length > 0">
      <ion-button 
        expand="block" 
        size="large"
        (click)="goToQuiz()"
        color="primary"
      >
          <ion-icon name="play" slot="start"></ion-icon>
        Fazer Novo Quiz
      </ion-button>

      <ion-button 
        expand="block" 
        size="large"
        (click)="clearHistory()"
        fill="outline"
        color="danger"
      >
          <ion-icon name="trash" slot="start"></ion-icon>
        Limpar Histórico
      </ion-button>
    </div>
    
    </div>
    <!-- Fim do conteúdo do Quiz -->

    <!-- Conteúdo do Jogo da Forca -->
    <div *ngIf="activeTab === 'hangman' && hangmanStats" class="tab-content">
      
      <div class="user-header">
        <div class="avatar-wrapper">
          <ion-icon name="game-controller"></ion-icon>
        </div>
        <div class="user-details">
            <h1>{{ stats.userName }}</h1>
            <p class="subtitle">{{ hangmanStats.gamesPlayed }} {{ hangmanStats.gamesPlayed === 1 ? 'jogo' : 'jogos' }} realizados</p>
        </div>
      </div>

      <!-- Cards de estatísticas do jogo da forca -->
      <div class="stats-grid">
        <ion-card class="stat-card glass-card">
          <ion-card-content>
            <ion-icon name="trophy" color="warning"></ion-icon>
            <div class="stat-value">{{ hangmanStats.gamesWon }}</div>
            <div class="stat-label">Vitórias</div>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card glass-card">
          <ion-card-content>
            <ion-icon name="close-circle" color="danger"></ion-icon>
            <div class="stat-value">{{ hangmanStats.gamesLost }}</div>
            <div class="stat-label">Derrotas</div>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card glass-card">
          <ion-card-content>
            <ion-icon name="flash" color="success"></ion-icon>
            <div class="stat-value">{{ hangmanStats.winRate }}%</div>
            <div class="stat-label">Vitória</div>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card glass-card">
          <ion-card-content>
            <ion-icon name="star" color="primary"></ion-icon>
            <div class="stat-value">{{ hangmanStats.totalScore }}</div>
            <div class="stat-label">Pontos</div>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card glass-card">
          <ion-card-content>
            <ion-icon name="flame" color="tertiary"></ion-icon>
            <div class="stat-value">{{ hangmanStats.currentStreak }}</div>
            <div class="stat-label">Sequência</div>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card glass-card">
          <ion-card-content>
            <ion-icon name="ribbon" color="secondary"></ion-icon>
            <div class="stat-value">{{ hangmanStats.bestStreak }}</div>
            <div class="stat-label">Recorde</div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Histórico de jogos da forca -->
      <ion-card class="history-card glass-card" *ngIf="hangmanStats.gamesPlayed > 0">
        <ion-card-header>
          <div class="history-header">
            <ion-card-title>
              <ion-icon name="time"></ion-icon>
              <span>Histórico de Jogos</span>
            </ion-card-title>
            <ion-button 
              *ngIf="hangmanStats.gamesPlayed > 5"
              fill="clear" 
              size="small"
              (click)="toggleAllHangmanGames()"
            >
              {{ showAllHangmanGames ? 'Ver menos' : 'Ver tudo' }}
            </ion-button>
          </div>
        </ion-card-header>
        <ion-card-content>
          <div class="hangman-games-list">
            <div class="hangman-game-item" *ngFor="let game of recentHangmanGames">
              <div class="game-icon">
                <ion-icon [name]="game.won ? 'trophy' : 'close-circle'" [color]="game.won ? 'success' : 'danger'"></ion-icon>
              </div>
              <div class="game-info">
                <div class="game-word-row">
                  <strong>{{ game.word }}</strong>
                  <ion-badge [color]="game.won ? 'success' : 'danger'">
                    {{ game.won ? 'Vitória' : 'Derrota' }}
                  </ion-badge>
                </div>
                <div class="game-details-row">
                  <span class="game-category">
                    <ion-icon name="folder"></ion-icon>
                    {{ game.category }}
                  </span>
                  <span class="game-errors">
                    <ion-icon name="close"></ion-icon>
                    {{ game.wrongGuesses }} erro(s)
                  </span>
                  <span class="game-score">
                    <ion-icon name="star"></ion-icon>
                    +{{ game.score }}
                  </span>
                </div>
                <span class="game-date">{{ formatDate(game.date) }}</span>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Estado vazio -->
      <div class="empty-state" *ngIf="hangmanStats.gamesPlayed === 0">
        <ion-icon name="game-controller-outline" class="empty-icon"></ion-icon>
        <h2>Nenhum jogo realizado</h2>
        <p>Divirta-se jogando forca!</p>
        <ion-button routerLink="/hangman" color="secondary" size="large">
          <ion-icon name="play" slot="start"></ion-icon>
          Jogar Agora
        </ion-button>
      </div>

      <!-- Ações -->
      <div class="action-buttons" *ngIf="hangmanStats.gamesPlayed > 0">
        <ion-button 
          expand="block" 
          size="large"
          routerLink="/hangman"
          color="secondary"
        >
          <ion-icon name="play" slot="start"></ion-icon>
          Jogar Forca
        </ion-button>

        <ion-button 
          expand="block" 
          size="large"
          (click)="clearHangmanHistory()"
          fill="outline"
          color="danger"
        >
          <ion-icon name="trash" slot="start"></ion-icon>
          Limpar Histórico
        </ion-button>
      </div>

    </div>
    <!-- Fim do conteúdo do Jogo da Forca -->

  </div>
</ion-content>
